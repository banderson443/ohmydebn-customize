#!/bin/bash

# ============================================================
# debn-pentest-setup.sh
# Automated pentesting tool suite installer for OhMyDebn
# ============================================================

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

TOOLS_DIR="/opt/tools"
LOG_FILE="$HOME/pentest-setup.log"

log() { echo -e "${GREEN}[+]${NC} $1" | tee -a $LOG_FILE; }
warn() { echo -e "${YELLOW}[!]${NC} $1" | tee -a $LOG_FILE; }
err() { echo -e "${RED}[-]${NC} $1" | tee -a $LOG_FILE; }

echo "============================================================"
echo "  debn Pentesting Suite Installer"
echo "============================================================"

# Must not run as root for some installs but needs sudo
if [ "$EUID" -eq 0 ]; then
    err "Do not run as root. Run as your user with sudo privileges."
    exit 1
fi

# Setup tools directory
log "Creating /opt/tools directory..."
sudo mkdir -p $TOOLS_DIR
sudo chown $USER:$USER $TOOLS_DIR

# ============================================================
# SYSTEM DEPS
# ============================================================
log "Installing system dependencies..."
sudo apt update -qq
sudo apt install -y \
    curl wget git build-essential cmake pkg-config \
    python3 python3-pip python3-dev python3-venv \
    ruby ruby-rubygems ruby-dev \
    libssl-dev libffi-dev libpcap-dev \
    libsqlite3-dev zlib1g-dev \
    mingw-w64 nasm \
    golang-go \
    openjdk-17-jdk \
    tmux net-tools dnsutils \
    2>/dev/null

# ============================================================
# APT TOOLS
# ============================================================
log "Installing apt-available tools..."
# Pre-answer wireshark debconf to avoid interactive prompt
echo "wireshark-common wireshark-common/install-setuid boolean false" | sudo debconf-set-selections
DEBIAN_FRONTEND=noninteractive sudo apt install -y \
    nmap \
    wireshark \
    sqlmap \
    hydra \
    john \
    wifite \
    aircrack-ng \
    netcat-openbsd \
    tcpdump \
    whois \
    smbclient \
    smbmap \
    recon-ng \
    arjun
log "apt tools installed."

# ============================================================
# EXPLOITDB (not in Debian 13 repos)
# ============================================================
log "Installing ExploitDB..."
if [ ! -d "$TOOLS_DIR/exploitdb" ]; then
    git clone https://gitlab.com/exploit-database/exploitdb.git $TOOLS_DIR/exploitdb -q
    sudo ln -sf $TOOLS_DIR/exploitdb/searchsploit /usr/local/bin/searchsploit
    # Create searchsploit config
    mkdir -p ~/.searchsploit_rc
    cp $TOOLS_DIR/exploitdb/.searchsploit_rc ~/.searchsploit_rc 2>/dev/null || true
    log "ExploitDB installed. Use: searchsploit"
else
    log "ExploitDB already installed, skipping."
fi

# ============================================================
# NIKTO (not in Debian 13 repos)
# ============================================================
log "Installing Nikto from GitHub..."
if [ ! -d "$TOOLS_DIR/nikto" ]; then
    git clone https://github.com/sullo/nikto.git $TOOLS_DIR/nikto -q
    echo '#!/bin/bash' | sudo tee /usr/local/bin/nikto > /dev/null
    echo "perl $TOOLS_DIR/nikto/program/nikto.pl \"\$@\"" | sudo tee -a /usr/local/bin/nikto > /dev/null
    sudo chmod +x /usr/local/bin/nikto
    sudo apt install -y libnet-ssleay-perl 2>/dev/null
    log "Nikto installed."
else
    log "Nikto already installed, skipping."
fi

# Allow wireshark for non-root
sudo usermod -aG wireshark $USER 2>/dev/null

# ============================================================
# GOBUSTER (Go)
# ============================================================
log "Installing GoBuster..."
go install github.com/OJ/gobuster/v3@latest 2>/dev/null
sudo ln -sf ~/go/bin/gobuster /usr/local/bin/gobuster 2>/dev/null
which gobuster && log "GoBuster installed." || err "GoBuster install failed."

# ============================================================
# METASPLOIT
# ============================================================
log "Installing Metasploit Framework..."
if ! which msfconsole > /dev/null 2>&1; then
    curl -sSL https://raw.githubusercontent.com/rapid7/metasploit-omnibus/master/config/templates/metasploit-framework-wrappers/msfupdate.erb > /tmp/msfinstall
    chmod +x /tmp/msfinstall
    sudo /tmp/msfinstall
    which msfconsole && log "Metasploit installed." || err "Metasploit install failed."
else
    log "Metasploit already installed, skipping."
fi

# ============================================================
# BURP SUITE COMMUNITY
# ============================================================
log "Installing Burp Suite Community..."
BURP_DIR="$TOOLS_DIR/burpsuite"
mkdir -p $BURP_DIR
if [ ! -f "$BURP_DIR/burpsuite.jar" ]; then
    BURP_URL=$(curl -s https://portswigger.net/burp/releases/community/latest | grep -oP 'https://[^"]+\.jar' | head -1)
    if [ -z "$BURP_URL" ]; then
        # Fallback direct download
        warn "Auto-detecting Burp URL failed, using direct download..."
        wget -q "https://portswigger.net/burp/releases/download?product=community&type=Jar" \
            -O "$BURP_DIR/burpsuite.jar"
    else
        wget -q "$BURP_URL" -O "$BURP_DIR/burpsuite.jar"
    fi

    # Create launcher script
    echo '#!/bin/bash' | sudo tee /usr/local/bin/burpsuite > /dev/null
    echo "java -jar $BURP_DIR/burpsuite.jar \"\$@\"" | sudo tee -a /usr/local/bin/burpsuite > /dev/null
    sudo chmod +x /usr/local/bin/burpsuite
    log "Burp Suite installed."
else
    log "Burp Suite already installed, skipping."
fi

# ============================================================
# IMPACKET
# ============================================================
log "Installing Impacket..."
if [ ! -d "$TOOLS_DIR/impacket" ]; then
    git clone https://github.com/fortra/impacket.git $TOOLS_DIR/impacket -q
    cd $TOOLS_DIR/impacket
    python3 -m venv venv
    source venv/bin/activate
    pip install -q . 
    deactivate
    cd ~

    # Create wrapper so impacket tools work globally
    echo '#!/bin/bash' | sudo tee /usr/local/bin/impacket-shell > /dev/null
    echo "source $TOOLS_DIR/impacket/venv/bin/activate" | sudo tee -a /usr/local/bin/impacket-shell > /dev/null
    echo 'exec "$@"' | sudo tee -a /usr/local/bin/impacket-shell > /dev/null
    sudo chmod +x /usr/local/bin/impacket-shell
    log "Impacket installed."
else
    log "Impacket already installed, skipping."
fi

# ============================================================
# EVIL-WINRM
# ============================================================
log "Installing Evil-WinRM..."
if ! which evil-winrm > /dev/null 2>&1; then
    # Ensure rubygems is installed
    sudo apt install -y ruby ruby-rubygems ruby-dev 2>/dev/null
    # Try gem install
    sudo gem install evil-winrm 2>&1
    if which evil-winrm > /dev/null 2>&1; then
        log "Evil-WinRM installed."
    else
        # Fallback - install from git
        warn "gem install failed, trying from source..."
        git clone https://github.com/Hackplayers/evil-winrm.git $TOOLS_DIR/evil-winrm -q
        echo '#!/bin/bash' | sudo tee /usr/local/bin/evil-winrm > /dev/null
        echo "ruby $TOOLS_DIR/evil-winrm/evil-winrm.rb "\$@"" | sudo tee -a /usr/local/bin/evil-winrm > /dev/null
        sudo chmod +x /usr/local/bin/evil-winrm
        sudo gem install winrm winrm-fs stringio logger 2>/dev/null
        log "Evil-WinRM installed from source."
    fi
else
    log "Evil-WinRM already installed, skipping."
fi

# ============================================================
# SLIVER C2
# ============================================================
log "Installing Sliver C2..."
if [ ! -f "/usr/local/bin/sliver" ]; then
    curl -sSL https://sliver.sh/install | sudo bash
    which sliver && log "Sliver installed." || err "Sliver install failed."
else
    log "Sliver already installed, skipping."
fi

# ============================================================
# HAVOC C2
# ============================================================
log "Installing Havoc C2 (building from source)..."
HAVOC_DIR="$TOOLS_DIR/havoc"
if [ ! -d "$HAVOC_DIR" ]; then
    # Build deps
    sudo apt install -y \
        libboost-all-dev \
        qtbase5-dev \
        qtchooser \
        qt5-qmake \
        qtbase5-dev-tools \
        libqt5websockets5-dev \
        python3-dev \
        nasm \
        2>/dev/null

    git clone https://github.com/HavocFramework/Havoc.git $HAVOC_DIR -q
    cd $HAVOC_DIR

    # Build teamserver
    log "Building Havoc teamserver..."
    cd $HAVOC_DIR/teamserver
    go mod download 2>/dev/null
    go build -o ../havoc-teamserver . 2>/dev/null

    # Build client
    log "Building Havoc client..."
    cd $HAVOC_DIR/client
    cmake -S . -B build -DCMAKE_BUILD_TYPE=Release 2>/dev/null
    cmake --build build 2>/dev/null

    # Create launcher scripts
    echo '#!/bin/bash' | sudo tee /usr/local/bin/havoc-server > /dev/null
    echo "cd $HAVOC_DIR" | sudo tee -a /usr/local/bin/havoc-server > /dev/null
    echo 'sudo ./havoc-teamserver server --profile profiles/havoc.yaotl "$@"' | sudo tee -a /usr/local/bin/havoc-server > /dev/null
    sudo chmod +x /usr/local/bin/havoc-server

    echo '#!/bin/bash' | sudo tee /usr/local/bin/havoc-client > /dev/null
    echo "cd $HAVOC_DIR/client/build" | sudo tee -a /usr/local/bin/havoc-client > /dev/null
    echo './Havoc "$@"' | sudo tee -a /usr/local/bin/havoc-client > /dev/null
    sudo chmod +x /usr/local/bin/havoc-client
    cd ~
    log "Havoc installed."
else
    log "Havoc already installed, skipping."
fi

# ============================================================
# WORDLISTS
# ============================================================
log "Setting up wordlists..."
sudo mkdir -p /usr/share/wordlists
if [ ! -f /usr/share/wordlists/rockyou.txt ]; then
    if [ -f /usr/share/wordlists/rockyou.txt.gz ]; then
        sudo gunzip /usr/share/wordlists/rockyou.txt.gz
        log "Rockyou wordlist extracted."
    else
        sudo wget -q https://github.com/brannondorsey/naive-hashcat/releases/download/data/rockyou.txt \
            -O /usr/share/wordlists/rockyou.txt
        log "Rockyou wordlist downloaded."
    fi
else
    log "Rockyou wordlist already present."
fi

# SecLists
if [ ! -d "/usr/share/seclists" ]; then
    log "Installing SecLists (this may take a few minutes)..."
    sudo git clone https://github.com/danielmiessler/SecLists.git /usr/share/seclists -q
    log "SecLists installed."
else
    log "SecLists already installed, skipping."
fi

# ============================================================
# SUMMARY
# ============================================================
echo ""
echo "============================================================"
echo "  Installation Summary"
echo "============================================================"
tools=("nmap" "wireshark" "nikto" "sqlmap" "hydra" "gobuster" "msfconsole" "sliver")
for tool in "${tools[@]}"; do
    if which $tool > /dev/null 2>&1; then
        echo -e "${GREEN}[+]${NC} $tool"
    else
        echo -e "${RED}[-]${NC} $tool - NOT FOUND"
    fi
done

# Check non-standard installs
# Check tools that may be in non-standard paths
for tool in john wifite; do
    if which $tool > /dev/null 2>&1 || find /usr /bin /sbin -name "$tool" 2>/dev/null | grep -q .; then
        echo -e "${GREEN}[+]${NC} $tool"
    else
        echo -e "${RED}[-]${NC} $tool - NOT FOUND"
    fi
done
[ -f "$BURP_DIR/burpsuite.jar" ] && echo -e "${GREEN}[+]${NC} burpsuite" || echo -e "${RED}[-]${NC} burpsuite - NOT FOUND"
[ -d "$TOOLS_DIR/impacket" ] && echo -e "${GREEN}[+]${NC} impacket" || echo -e "${RED}[-]${NC} impacket - NOT FOUND"
[ -d "$HAVOC_DIR" ] && echo -e "${GREEN}[+]${NC} havoc" || echo -e "${RED}[-]${NC} havoc - NOT FOUND"
[ -f "/usr/share/wordlists/rockyou.txt" ] && echo -e "${GREEN}[+]${NC} rockyou.txt" || echo -e "${RED}[-]${NC} rockyou.txt - NOT FOUND"
[ -d "/usr/share/seclists" ] && echo -e "${GREEN}[+]${NC} seclists" || echo -e "${RED}[-]${NC} seclists - NOT FOUND"
[ -f "/usr/local/bin/searchsploit" ] && echo -e "${GREEN}[+]${NC} exploitdb/searchsploit" || echo -e "${RED}[-]${NC} exploitdb - NOT FOUND"

echo ""
echo "============================================================"
warn "NOTE: Log out and back in for wireshark group to take effect"
warn "NOTE: Havoc build from source may need manual fixes on Debian 13"
warn "NOTE: Full log at $LOG_FILE"
echo "============================================================"
echo -e "${GREEN}Done!${NC}"
